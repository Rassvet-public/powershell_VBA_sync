# Sync-VBA.ps1

PowerShell-скрипт для безопасной синхронизации VBA-кода между Excel-книгой и файловой структурой проекта. Скрипт автоматически определяет кодировки, ведёт журнал, отображает прогресс и корректно управляет процессами Excel.

## Возможности
- Экспорт и импорт модулей, классов и форм VBA с сохранением кодировки UTF-8 BOM.
- Автоматическое исправление кракозябр (mojibake), появившихся из-за ANSI/1252.
- Перезапуск в 32-битной версии PowerShell для совместимости с 32-битным Excel.
- Управление экземпляром Excel: подключение к существующему, запуск нового, отключение предупреждений и событий.
- Логирование действий в `SyncVBA.log` с метками времени и цветной консолью.
- Полуавтоматический выбор Excel-книги и предпросмотр первых строк экспортируемого кода.
- Опциональное открытие каталога `VBA` в VS Code после экспорта.
- Импорт форм с копированием `.frx` и удалением старых версий.
- Режим завершения всех процессов Excel (`KillExcel`).

## Использование
1. Скопируйте `Sync-VBA.ps1` в корень проекта Excel (рядом с `.xlsm`).
2. Запустите PowerShell с правами, позволяющими работать с COM (при необходимости выполните `Set-ExecutionPolicy Bypass -Scope Process`).
3. Выполните скрипт:
   ```powershell
   .\Sync-VBA.ps1
   ```
4. Выберите режим:
   - `1` — только экспорт модулей в папку `VBA`.
   - `2` — только импорт модулей из папки `VBA` в книгу.
   - `3` — экспорт, затем импорт (для синхронизации перед сборкой).
   - `4` — принудительное завершение всех процессов Excel.

По умолчанию скрипт ищет файлы `.xlsm` в текущем каталоге. Если нужная книга не найдена, можно вручную указать путь.

## Структура проекта
```
.
├── README.md
└── Sync-VBA.ps1
```

Скрипт создаёт подпапку `VBA` для выгрузки модулей и журнал `SyncVBA.log`. Эти файлы можно добавить в `.gitignore`, если журнал не требуется в репозитории.

## Требования
- Windows с установленным Excel (желательно 2016/365).
- PowerShell 5.1 (x64 или x86; для некоторых сценариев потребуется автоматический переход в x86).
- Разрешённый доступ к объектной модели VBA (в Excel: Параметры → Центр управления безопасностью → Доступ доверенных приложений к VBA). 

## Советы
- Для корректного импорта/экспорта форм (`.frm/.frx`) убедитесь, что Excel закрыт или не блокирует файлы в целевой папке.
- Если используется система контроля версий, добавьте экспортируемую папку `VBA` в репозиторий — так изменения в VBA будут отслеживаться наравне с остальным кодом.
- При выполнении из x64 PowerShell на 32-битном Office скрипт автоматически перезапустится в нужной архитектуре.
