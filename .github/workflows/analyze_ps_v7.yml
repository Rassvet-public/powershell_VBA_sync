name: PSScriptAnalyzer Check v7

on:
  push:
    branches: [ dev, master, codex ]
  pull_request:
    branches: [ dev, master, codex ]

jobs:
  pssa:
    runs-on: windows-latest

    steps:
      # ---------------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. Install PowerShell 7
      # ---------------------------------------------------------
      - name: Install PowerShell 7
        run: |
          $url = "https://github.com/PowerShell/PowerShell/releases/download/v7.4.2/PowerShell-7.4.2-win-x64.zip"
          Invoke-WebRequest -Uri $url -OutFile pwsh.zip
          Expand-Archive pwsh.zip -DestinationPath pwsh7
          echo "$PWD\pwsh7\pwsh.exe" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # ---------------------------------------------------------
      # 3. Show PowerShell version
      # ---------------------------------------------------------
      - name: Show PowerShell version
        run: pwsh -c "Write-Host (Get-Host).Version"

      # ---------------------------------------------------------
      # 4. Install PSScriptAnalyzer
      # ---------------------------------------------------------
      - name: Install PSScriptAnalyzer
        run: pwsh -c "Install-Module PSScriptAnalyzer -Force -Scope CurrentUser"

      # ---------------------------------------------------------
      # 5. Run PSScriptAnalyzer with AST validation (per file)
      # ---------------------------------------------------------
      - name: Run per-file AST + PSScriptAnalyzer
        run: |
          pwsh -c '
            Set-StrictMode -Version Latest
            $ErrorActionPreference = "Stop"

            # Path to RuleSet file (CORRECT for GitHub runner)
            $ruleSet = Join-Path $PWD ".github/PSScriptAnalyzerRuleSet.psd1"
            Write-Host "=== Using RuleSet:" $ruleSet

            if (-not (Test-Path $ruleSet)) {
                Write-Host "? ERROR: RuleSet not found > $ruleSet"
                exit 1
            }

            # Collect all .ps1 files
            $files = Get-ChildItem -Recurse -Filter *.ps1 |
                Where-Object { $_.FullName -notmatch 'pwsh7' }


            if ($files.Count -eq 0) {
                Write-Host "? No .ps1 files found â€” skipping"
                exit 0
            }

            $hasErrors = $false

            foreach ($file in $files) {

                Write-Host ""
                Write-Host "=== Checking file: $($file.FullName)"

                # -------------------------------------------------
                # 1. AST Syntax check
                # -------------------------------------------------
                $ast = $null
                $parseErrors = $null

                [void][System.Management.Automation.Language.Parser]::ParseFile(
                    $file.FullName,
                    [ref]$ast,
                    [ref]$parseErrors
                )

                if ($parseErrors) {
                    Write-Host "? Syntax errors in $($file.Name):"
                    $parseErrors | Format-List
                    $hasErrors = $true
                    continue
                }

                # -------------------------------------------------
                # 2. PSScriptAnalyzer with RuleSet
                # -------------------------------------------------
                $result = Invoke-ScriptAnalyzer `
                             -Path $file.FullName `
                             -Settings $ruleSet

                if ($result) {
                    Write-Host "? PSScriptAnalyzer findings in $($file.Name):"
                    $result | Format-List
                    $hasErrors = $true
                }
                else {
                    Write-Host "? OK: $($file.Name)"
                }
            }

            if ($hasErrors) {
                Write-Host ""
                Write-Host "? FAIL: Issues detected"
                exit 1
            }

            Write-Host ""
            Write-Host "? SUCCESS: All PowerShell files passed AST + PSSA"
          '
