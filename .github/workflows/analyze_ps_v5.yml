name: PSScriptAnalyzer Check v5

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ dev, master ]

jobs:
  pssa:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show PowerShell version
        shell: pwsh
        run: '$PSVersionTable.PSVersion'

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer using custom RuleSet
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $ruleSet = Join-Path $PWD ".github\PSScriptAnalyzerRuleSet.psd1"
          Write-Host "Using RuleSet file: $ruleSet"

          $files = Get-ChildItem -Recurse -Filter *.ps1
          if (-not $files) {
            Write-Host "No .ps1 files found."
            exit 0
          }

          $hadErrors = $false

          foreach ($file in $files) {

            Write-Host "=== Parsing $($file.FullName)"

            $ast = $null
            $parseErrors = $null
            [void][System.Management.Automation.Language.Parser]::ParseFile(
              $file.FullName,
              [ref]$ast,
              [ref]$parseErrors
            )

            if ($parseErrors) {
              Write-Host "Parse errors in $($file.FullName):"
              $parseErrors | Format-List
              $hadErrors = $true
              continue
            }

            Write-Host "=== Running PSScriptAnalyzer for $($file.Name)"
            $diag = Invoke-ScriptAnalyzer -Path $file.FullName -CustomRulePath $ruleSet

            if ($diag) {
              Write-Host "Diagnostics for $($file.Name):"
              $diag | Format-List
              $hadErrors = $true
            }
          }

          if ($hadErrors) {
            Write-Error "Syntax or PSScriptAnalyzer errors found."
            exit 1
          }

          Write-Host "All PowerShell files passed RuleSet analysis."
